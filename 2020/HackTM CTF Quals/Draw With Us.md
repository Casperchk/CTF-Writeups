# Draw With Us

## Challenge

<img src="https://i.imgur.com/1imiCXO.png"/>

[stripped.js](https://ctfx.hacktm.ro/download?file_key=ce09444dba18b75e6c3af1ac63a4c65e175cedd46958433089b06fa85e90bba2&team_key=0f6267bf2c756b2ba7567b44cc440e528e713daafd49adc5d4188d2931729356)


## Solution

### What's preventing us from getting the flag?

This is the code that returns the flag (`/flag`):

```javascript
  if (req.user.id == 0) {
    res.send(ok({ flag: flag }));
```

`req.user.id` is determined by the value in a signed Json Web Token that is being sent which is randomly generated by the server at login.
We have to get a signed token with and `id` or 0. The secret that is used to sign is never explosed so its secure.


The only other place that returns a signed JWT is `/init`:

```javascript
let adminId = pwHash
    .split("")
    .map((c, i) => c.charCodeAt(0) ^ target.charCodeAt(i))
    .reduce((a, b) => a + b);
    
  res.json(ok({ token: sign({ id: adminId }) }));
```

For `adminId` to be 0,  we need `target xor pwHash = 0` which means `target === pwHash`.

* `target` is the md5 sum of `config.n`.
* `pwHash` is the md5 sum of `q*p` which are variables that are given as parameter.

We need to get `config.n`.

-----

Thanksfully `/serverInfo` returns some of the properties of `config`:

```javascript
app.get("/serverInfo", (req, res) => {
  let user = users[req.user.id] || { rights: [] };
  let info = user.rights.map(i => ({ name: i, value: config[i] }));
  res.json(ok({ info: info }));
});
```

The default rights for each user are:

`[ "message", "height", "width", "version", "usersOnline", "adminUsername", "backgroundColor" ]`

We need to add `n` and `p` to our users rights.

The method `/updateUser` allows us to send a list of rights to add to our users rights list.

But when we POST `["p", "n"]` we get:

`"You're not an admin!"`

as a response due to the following code:

```javascript
if (!user || !isAdmin(user)) {
  res.json(err("You're not an admin!"));
  return;
}
```

------

### Bypassing isAdmin(u)

```javascript
function isAdmin(u) {
  return u.username.toLowerCase() == config.adminUsername.toLowerCase();
}
```

We need to make `username.toLowerCase() === adminUsername.toLowerCase()`.

If we try to login (`/login`) with the admin username: `hacktm` we get:

`Invalid creds`

Its due to `isValidUser()` in `/login`. It checks that:

```javascript
u.username.toUpperCase() !== config.adminUsername.toUpperCase()
````

So we need: 
* `u.username.toUpperCase() !== config.adminUsername.toUpperCase()`
* `username.toLowerCase() === adminUsername.toLowerCase()`

